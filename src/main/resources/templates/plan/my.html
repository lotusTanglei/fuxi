<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{common/layout :: layout(~{::div})}">
<body>
<div>
    <div class="layui-card">
        <div class="layui-card-header">我的待办</div>
        <div class="layui-card-body">
            <table id="myPlanTable" lay-filter="myPlanTable"></table>
            
            <script type="text/html" id="barDemo">
                <a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
                
                {{#  if(d.status === 'PENDING'){ }}
                    <!-- OPS Action: Start Execution -->
                    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="execute">执行</a>
                {{#  } }}
                
                {{#  if(d.status === 'RUNNING'){ }}
                    <!-- OPS Action: Submit Receipt -->
                    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="receipt">回执</a>
                {{#  } }}
                
                {{#  if(d.status === 'VERIFYING_TEST'){ }}
                    <!-- TEST Action -->
                    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="verify_test">验证</a>
                {{#  } }}
                
                {{#  if(d.status === 'VERIFYING_LEADER'){ }}
                    <!-- LEADER Action -->
                    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="finalize">结项</a>
                {{#  } }}
            </script>
        </div>
    </div>

    <link rel="stylesheet" href="//unpkg.com/simplemde/dist/simplemde.min.css">
    <script src="//unpkg.com/simplemde/dist/simplemde.min.js"></script>

    <script>
        layui.use(['table', 'layer', 'form', 'jquery'], function(){
            var table = layui.table;
            var layer = layui.layer;
            var $ = layui.jquery;
            
            // Render Table
            table.render({
                id: 'myPlanTable',
                elem: '#myPlanTable',
                url: '/plan/api/my',
                cols: [
                    [
                        {type: 'numbers', title: '序号', width: 80},
                        {field: 'title', title: '任务标题', width: 200},
                        {field: 'targetSite', title: '目标现场', width: 150},
                        {field: 'status', title: '状态', width: 150, templet: function(d){
                            if(d.status === 'PENDING') return '<span class="layui-badge layui-bg-orange">待执行</span>';
                            if(d.status === 'RUNNING') return '<span class="layui-badge layui-bg-blue">执行中</span>';
                            if(d.status === 'VERIFYING_TEST') return '<span class="layui-badge layui-bg-cyan">待测试验证</span>';
                            if(d.status === 'VERIFYING_LEADER') return '<span class="layui-badge layui-bg-blue">待主管结项</span>';
                            if(d.status === 'COMPLETED') return '<span class="layui-badge layui-bg-green">已完成</span>';
                            return d.status;
                        }},
                        {field: 'createdAt', title: '创建时间', width: 180},
                        {fixed: 'right', title:'操作', toolbar: '#barDemo', width: 200}
                    ]
                ],
                page: true
            });
            
            // Tool Bar
            table.on('tool(myPlanTable)', function(obj){
                var data = obj.data;
                if(obj.event === 'detail'){
                    window.location.href = '/plan/detail/' + data.id;
                } else if(obj.event === 'execute'){
                    layer.confirm('确认开始执行任务？', function(index){
                        $.post('/plan/execute/' + data.id, function(res){
                            if(res.code === 0){
                                layer.msg('任务已开始');
                                table.reload('myPlanTable');
                            } else {
                                layer.msg(res.msg);
                            }
                        });
                        layer.close(index);
                    });
                } else if(obj.event === 'receipt'){
                    // Submit Receipt Popup
                    layer.open({
                        type: 1,
                        title: '请输入执行回执 (支持 Markdown)',
                        area: ['800px', '600px'],
                        content: '<div style="padding: 10px;"><textarea id="receiptEditor"></textarea></div>',
                        btn: ['提交', '取消'],
                        success: function(layero, index){
                            // Initialize SimpleMDE
                            var simplemde = new SimpleMDE({
                                element: document.getElementById("receiptEditor"),
                                spellChecker: false,
                                status: false,
                                placeholder: "请输入回执内容，支持 Markdown 和图片上传...",
                                toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|", "preview", "side-by-side", "fullscreen", "|", "guide",
                                    {
                                        name: "upload-image",
                                        action: function customFunction(editor){
                                            $('#imageUploadInput').click();
                                        },
                                        className: "fa fa-upload",
                                        title: "上传图片"
                                    }
                                ]
                            });
                            
                            // Add hidden file input for upload
                            $('body').append('<input type="file" id="imageUploadInput" style="display:none" accept="image/*">');
                            
                            // Handle file upload
                            $('#imageUploadInput').on('change', function(){
                                var file = this.files[0];
                                if(file){
                                    var formData = new FormData();
                                    formData.append('image', file);
                                    var token = $("meta[name='_csrf']").attr("content");
                                    var header = $("meta[name='_csrf_header']").attr("content");
                                    
                                    $.ajax({
                                        url: '/upload/image',
                                        type: 'POST',
                                        data: formData,
                                        processData: false,
                                        contentType: false,
                                        beforeSend: function(xhr) {
                                            if(header && token) xhr.setRequestHeader(header, token);
                                        },
                                        success: function(res){
                                            if(res.code === 0){
                                                var cm = simplemde.codemirror;
                                                var doc = cm.getDoc();
                                                var cursor = doc.getCursor();
                                                var imageMarkdown = '![' + res.data.filename + '](' + res.data.url + ')';
                                                doc.replaceRange(imageMarkdown, cursor);
                                            } else {
                                                layer.msg(res.msg);
                                            }
                                            $('#imageUploadInput').val('');
                                        },
                                        error: function(){
                                            layer.msg('上传失败');
                                            $('#imageUploadInput').val('');
                                        }
                                    });
                                }
                            });
                            
                            // Store instance
                            window.currentSimpleMDE = simplemde;
                        },
                        yes: function(index, layero){
                            var value = window.currentSimpleMDE.value();
                            if(!value){
                                layer.msg('请输入内容');
                                return;
                            }
                            
                            var token = $("meta[name='_csrf']").attr("content");
                            var header = $("meta[name='_csrf_header']").attr("content");
                            
                            $.ajax({
                                url: '/plan/receipt/' + data.id,
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({ receipt: value }),
                                beforeSend: function(xhr) {
                                    if(header && token) xhr.setRequestHeader(header, token);
                                },
                                success: function(res){
                                    if(res.code === 0){
                                        layer.msg('回执提交成功');
                                        layer.close(index);
                                        table.reload('myPlanTable');
                                    } else {
                                        layer.msg(res.msg);
                                    }
                                }
                            });
                            $('#imageUploadInput').remove();
                        },
                        end: function(){
                            $('#imageUploadInput').remove();
                        }
                    });
                } else if (obj.event === 'verify_test') {
                    // TEST Verify Logic
                    // Requirement: TEST confirmation.
                    layer.confirm('确认验证通过吗？', {
                        btn: ['通过', '不通过', '取消']
                    }, function(index){
                        // Pass
                         $.post('/plan/verify/test/' + data.id, {pass: true}, function(res){
                             if(res.code === 0) { layer.msg('验证已通过'); table.reload('myPlanTable'); }
                             else { layer.msg(res.msg); }
                         });
                         layer.close(index);
                    }, function(index){
                        // Fail
                         $.post('/plan/verify/test/' + data.id, {pass: false}, function(res){
                             if(res.code === 0) { layer.msg('验证不通过'); table.reload('myPlanTable'); }
                             else { layer.msg(res.msg); }
                         });
                         layer.close(index);
                    });
                } else if (obj.event === 'finalize') {
                    // LEADER Finalize Logic
                    layer.confirm('确认结项吗？', function(index){
                        $.post('/plan/finalize/' + data.id, function(res){
                            if(res.code === 0){
                                layer.msg('任务已结项');
                                table.reload('myPlanTable');
                            } else {
                                layer.msg(res.msg);
                            }
                        });
                        layer.close(index);
                    });
                }
            });
        });
    </script>
</div>
</body>
</html>