<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{common/layout :: layout(~{::div})}">
<body>
<div>
    <div class="layui-card">
        <div class="layui-card-header">
            <span style="font-size: 18px; margin-right: 10px;" th:text="${plan.title}">任务标题</span>
            <span id="planStatusBadge" class="layui-badge layui-bg-gray" th:text="${plan.status}">STATUS</span>
            <div style="float: right;">
                <!-- Buttons are controlled by backend status validation, but we can hide them here too -->
                <a href="/plan/list" class="layui-btn layui-btn-primary layui-btn-sm">返回列表</a>
            </div>
        </div>
        <div class="layui-card-body">
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <div class="layui-card-body" style="background-color: #f8f8f8;">
                            <p><strong>目标现场：</strong> <span th:text="${plan.targetSite}"></span></p>
                            <p><strong>描述信息：</strong> <span th:text="${plan.description}"></span></p>
                            <p><strong>当前状态：</strong> <span th:text="${plan.status}"></span></p>
                            
                            <!-- Workflow Actions (Visible based on Status) -->
                            <div style="margin-top: 10px;">
                                <!-- OPS Action: Execute (PENDING) -->
                                <button class="layui-btn layui-btn-warm layui-btn-sm" id="executeBtn" 
                                    th:if="${plan.status == 'PENDING'}" sec:authorize="hasAnyRole('ADMIN', 'OPS')">
                                    <i class="layui-icon layui-icon-play"></i> 执行任务
                                </button>
                                
                                <!-- OPS Action: Submit Receipt (RUNNING) -->
                                <button class="layui-btn layui-btn-normal layui-btn-sm" id="receiptBtn" 
                                    th:if="${plan.status == 'RUNNING'}" sec:authorize="hasAnyRole('ADMIN', 'OPS')">
                                    <i class="layui-icon layui-icon-form"></i> 填写回执
                                </button>
                                
                                <!-- TEST Action: Verify (VERIFYING_TEST) -->
                                <button class="layui-btn layui-btn-normal layui-btn-sm" id="verifyTestBtn" 
                                    th:if="${plan.status == 'VERIFYING_TEST'}" sec:authorize="hasAnyRole('ADMIN', 'TEST')">
                                    <i class="layui-icon layui-icon-auz"></i> 验证通过
                                </button>
                                <button class="layui-btn layui-btn-danger layui-btn-sm" id="rejectTestBtn" 
                                    th:if="${plan.status == 'VERIFYING_TEST'}" sec:authorize="hasAnyRole('ADMIN', 'TEST')">
                                    <i class="layui-icon layui-icon-close"></i> 验证不通过
                                </button>
                                
                                <!-- LEADER Action: Finalize (VERIFYING_LEADER) -->
                                <button class="layui-btn layui-btn-danger layui-btn-sm" id="finalizeBtn" 
                                    th:if="${plan.status == 'VERIFYING_LEADER'}" sec:authorize="hasAnyRole('ADMIN', 'LEADER')">
                                    <i class="layui-icon layui-icon-ok"></i> 结项
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <table id="itemTable" lay-filter="itemTable"></table>
            
            <script type="text/html" id="barDemo">
                <!-- Item level verification removed/hidden as we moved to Plan level verification -->
            </script>
        </div>
    </div>

    <link rel="stylesheet" href="//unpkg.com/simplemde/dist/simplemde.min.css">
    <script src="//unpkg.com/simplemde/dist/simplemde.min.js"></script>

    <script th:inline="javascript">
        layui.use(['table', 'layer', 'jquery'], function(){
            var table = layui.table;
            var layer = layui.layer;
            var $ = layui.jquery;
            
            var planId = [[${plan.id}]];
            var planStatus = [[${plan.status}]];
            
            // Status Badge Color
            function updateStatusBadge(status) {
                var color = 'layui-bg-gray';
                if(status === 'PENDING') color = 'layui-bg-orange';
                if(status === 'RUNNING') color = 'layui-bg-blue';
                if(status === 'VERIFYING_TEST') color = 'layui-bg-cyan';
                if(status === 'VERIFYING_LEADER') color = 'layui-bg-blue';
                if(status === 'COMPLETED') color = 'layui-bg-green';
                
                $('#planStatusBadge').attr('class', 'layui-badge ' + color).text(status);
            }
            updateStatusBadge(planStatus);
            
            // Render Table
            table.render({
                elem: '#itemTable',
                url: '/plan/api/items/' + planId,
                cols: [
                    [
                        {field: 'sortOrder', title: '顺序', width: 80, align: 'center'},
                        {title: '脚本', width: 250, templet: function(d){
                            return '<a href="javascript:;" class="layui-table-link" lay-event="viewScript">' + d.scriptTitle + '</a> <span class="layui-badge layui-bg-gray">v' + d.versionNum + '</span>';
                        }},
                        {field: 'scriptType', title: '类型', width: 100, align: 'center', templet: function(d){
                            if(d.scriptType === 'SQL') return '<span class="layui-badge layui-bg-blue">SQL</span>';
                            if(d.scriptType === 'SHELL') return '<span class="layui-badge layui-bg-black">Shell</span>';
                            return d.scriptType;
                        }},
                        {field: 'scriptTargetEnv', title: '目标环境', width: 150, align: 'center', templet: function(d){
                            if(d.scriptTargetEnv === 'MySQL') return '<span class="layui-badge layui-bg-green">MySQL</span>';
                            if(d.scriptTargetEnv === 'Oracle') return '<span class="layui-badge layui-bg-orange">Oracle</span>';
                            if(d.scriptTargetEnv === 'Linux') return '<span class="layui-badge layui-bg-black">Linux</span>';
                            if(d.scriptTargetEnv === 'Windows') return '<span class="layui-badge layui-bg-blue">Windows</span>';
                            return d.scriptTargetEnv;
                        }},
                        {field: 'scriptCreatedBy', title: '创建人', width: 120, align: 'center'}
                    ]
                ]
            });
            
            // Tool Bar
            table.on('tool(itemTable)', function(obj){
                var data = obj.data;
                if(obj.event === 'viewScript'){
                    // Fetch script content
                    $.get('/script/api/version/' + data.scriptVersionId, function(res){
                        if(res.code === 0){
                            var content = res.data.content;
                            // Show in layer
                            layer.open({
                                type: 1,
                                title: '脚本内容: ' + data.scriptTitle + ' (v' + data.versionNum + ')',
                                area: ['800px', '600px'],
                                content: '<pre style="padding: 15px; background: #f5f5f5; border: 1px solid #ddd; height: 530px; overflow: auto; margin: 0;">' + 
                                         layui.util.escape(content) + '</pre>',
                                shadeClose: true
                            });
                        } else {
                            layer.msg('获取脚本内容失败: ' + res.msg);
                        }
                    });
                }
            });
            
            // OPS Execute
            $('#executeBtn').on('click', function(){
                layer.confirm('确定要开始执行该任务包吗？', function(index){
                    $.post('/plan/execute/' + planId, function(res){
                        if(res.code === 0){
                            layer.msg('任务已启动');
                            setTimeout(function(){ location.reload(); }, 1000);
                        } else {
                            layer.msg(res.msg);
                        }
                    });
                    layer.close(index);
                });
            });
            
            // OPS Receipt
            $('#receiptBtn').on('click', function(){
                layer.open({
                    type: 1,
                    title: '请输入执行回执 (支持 Markdown)',
                    area: ['800px', '600px'],
                    content: '<div style="padding: 10px;"><textarea id="receiptEditor"></textarea></div>',
                    btn: ['提交', '取消'],
                    success: function(layero, index){
                        // Initialize SimpleMDE
                        var simplemde = new SimpleMDE({
                            element: document.getElementById("receiptEditor"),
                            spellChecker: false,
                            status: false,
                            placeholder: "请输入回执内容，支持 Markdown 和图片上传...",
                            toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|", "preview", "side-by-side", "fullscreen", "|", "guide",
                                {
                                    name: "upload-image",
                                    action: function customFunction(editor){
                                        $('#imageUploadInput').click();
                                    },
                                    className: "fa fa-upload",
                                    title: "上传图片"
                                }
                            ]
                        });
                        
                        // Add hidden file input for upload
                        $('body').append('<input type="file" id="imageUploadInput" style="display:none" accept="image/*">');
                        
                        // Handle file upload
                        $('#imageUploadInput').on('change', function(){
                            var file = this.files[0];
                            if(file){
                                var formData = new FormData();
                                formData.append('image', file);
                                var token = $("meta[name='_csrf']").attr("content");
                                var header = $("meta[name='_csrf_header']").attr("content");
                                
                                $.ajax({
                                    url: '/upload/image',
                                    type: 'POST',
                                    data: formData,
                                    processData: false,
                                    contentType: false,
                                    beforeSend: function(xhr) {
                                        if(header && token) xhr.setRequestHeader(header, token);
                                    },
                                    success: function(res){
                                        if(res.code === 0){
                                            var cm = simplemde.codemirror;
                                            var doc = cm.getDoc();
                                            var cursor = doc.getCursor();
                                            var imageMarkdown = '![' + res.data.filename + '](' + res.data.url + ')';
                                            doc.replaceRange(imageMarkdown, cursor);
                                        } else {
                                            layer.msg(res.msg);
                                        }
                                        $('#imageUploadInput').val('');
                                    },
                                    error: function(){
                                        layer.msg('上传失败');
                                        $('#imageUploadInput').val('');
                                    }
                                });
                            }
                        });
                        
                        // Store instance
                        window.currentSimpleMDE = simplemde;
                    },
                    yes: function(index, layero){
                        var value = window.currentSimpleMDE.value();
                        if(!value){
                            layer.msg('请输入内容');
                            return;
                        }
                        
                        $.ajax({
                            url: '/plan/receipt/' + planId,
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({ receipt: value }),
                            success: function(res){
                                if(res.code === 0){
                                    layer.msg('回执提交成功');
                                    setTimeout(function(){ location.reload(); }, 1000);
                                } else {
                                    layer.msg(res.msg);
                                }
                            }
                        });
                        layer.close(index);
                        $('#imageUploadInput').remove();
                    },
                    end: function(){
                        $('#imageUploadInput').remove();
                    }
                });
            });
            
            // TEST Verify Pass
            $('#verifyTestBtn').on('click', function(){
                layer.confirm('确认验证通过？', function(index){
                    $.ajax({
                        url: '/plan/verify/test/' + planId,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ pass: true }),
                        success: function(res){
                            if(res.code === 0){
                                layer.msg('验证已通过');
                                setTimeout(function(){ location.reload(); }, 1000);
                            } else {
                                layer.msg(res.msg);
                            }
                        }
                    });
                    layer.close(index);
                });
            });
            
            // TEST Verify Fail
            $('#rejectTestBtn').on('click', function(){
                layer.confirm('确认验证不通过？(将退回至待执行状态)', function(index){
                    $.ajax({
                        url: '/plan/verify/test/' + planId,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ pass: false }),
                        success: function(res){
                            if(res.code === 0){
                                layer.msg('已退回');
                                setTimeout(function(){ location.reload(); }, 1000);
                            } else {
                                layer.msg(res.msg);
                            }
                        }
                    });
                    layer.close(index);
                });
            });
            
            // LEADER Finalize
            $('#finalizeBtn').on('click', function(){
                layer.confirm('确认结项？', function(index){
                    $.post('/plan/finalize/' + planId, function(res){
                        if(res.code === 0){
                            layer.msg('已结项');
                            setTimeout(function(){ location.reload(); }, 1000);
                        } else {
                            layer.msg(res.msg);
                        }
                    });
                    layer.close(index);
                });
            });

            // Polling for updates if running
            if (planStatus === 'RUNNING') {
                setInterval(function(){
                    // table.reload('itemTable'); // Disable auto-refresh based on user feedback
                }, 10000);
            }
        });
    </script>
</div>
</body>
</html>
